# Драйвер шагового двигателя, управляемый двумя пинами микроконтроллера
Управление двумя H-мостами на транзисторах, используя два пина микроконтроллера с тремя состояниями.

Проблема: 
1. Необходимость использовать дешёвый драйвер для управления миниатюрным биполярным шаговым двигателем (альтернатива микросхеме STSPIN220).
2. Необходимость до минимума сократить количество пинов микроконтроллера, необходимых для управления двигателем, при этом, должна сохраниться возможность реализовывать волновой, полношаговый и полушаговый режимы управления двигателем.
3. Оптимизация отношения цена/функциональность.

Решение: каждый пин порта микроконтроллера (в данном случае микроконтроллер AVR) может находится в одном из трёх состояний: подтянут к плюсу питания, подтянут к минусу питания, находится в высокоимпедансном (HZ) состоянии. Три состояния теоретически позволяет контроллировать Н-мост, осущесвтляющий коммутацию обмотки двигателя: ток течёт в одну сторону, ток течёт в другую сторону (смена полярности напряжения), ток равен нулю. Используя два Н-моста для управления двумя обмотками биполярного шагового двигателя возможно реализовать простой драйвер, управляемый двумя пинами микроконтроллера.

Задача: разработать схему, осуществляющую преобразование трёх состояний пина микроконтроллера в сигналы, пригодные для управления Н-мостом.

В качестве микроконтроллера был выбран ATtiny13A в корпусе DFN10. Для управления шаговым двигателем используется две кнопки. При нажатии на одну кнопку, двигатель вращается влево, при нажатии на другую кнопку - вправо. Количесвто шагов определяется программой. Скорость вращения не изменяется и задаётся программно.

Разработана отладочная плата. Схема обвязки микроконтроллера:
![Схема обвязки контроллера](https://github.com/ArtemMechanik/step-motor-driver-from-tow-MCU-pins/blob/728c46927e7084a70d6689771b289ed3af0d1047/source/%D0%A1%D1%85%D0%B5%D0%BC%D0%B0%20%D0%BE%D0%B1%D0%B2%D1%8F%D0%B7%D0%BA%D0%B8%20%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D0%BB%D0%B5%D1%80%D0%B0.jpg)

Предложена следующая схема работы переключателя.Схема является коммутатором, вход подключается к пину микроконтроллера. По умолчанию выходы out1 и out2 подтянуты к питанию. Пин микроконтроллера может иметь три состояния:
1. Конфигурация на выход. Подтянут к питанию. В этом случае out2 прижимается к земле.
2. Конфигурация на выход. Подтянут к земле. В этом случае out1 прижимается к земле. 
3. Конфигурация на вход (HZ). В этом случае out1 и out2 остаются подтянутыми к питанию.
Входные транзисторы с общей базой образуют пару компараторов. Напряжение на базах равно половине напряжения питания. Напряжение на эммитерах не отличается от напряжения базы больше чем на 0.6В, поэтому транзисторы закрыты. Как только появляет перекос напряжения на эммитерах, отдин из транзисторов открывается.
![Схема ключа](https://github.com/ArtemMechanik/step-motor-driver-from-tow-MCU-pins/blob/80592bf404732544977e2eb65395976c6f3e5cff/source/%D0%A1%D1%85%D0%B5%D0%BC%D0%B0%20%D0%BA%D0%BB%D1%8E%D1%87%D0%B0.jpg)

Произведено моделирование работы ключа на биполярных транзисторах в Multisim 14.1. Результаты моделирования показали работоспособность концепции.
![Моделирование ключа](https://github.com/ArtemMechanik/step-motor-driver-from-tow-MCU-pins/blob/546a96e8b6ccaca532298826af7d1de0fa4b8c20/source/%D0%9C%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C%20%D0%BA%D0%BB%D1%8E%D1%87%D0%B0.jpg)

Для коммутации обмотки шагового двигателя была выбрана схема классического Н-моста. Никаких схемотехнических решений по организации зажержек при переключении направления тока в нагрузке (deadtime) не предусмотрена. Организация deadtime осуществляется программно.
![Схема Н-моста](https://github.com/ArtemMechanik/step-motor-driver-from-tow-MCU-pins/blob/728c46927e7084a70d6689771b289ed3af0d1047/source/%D0%A1%D1%85%D0%B5%D0%BC%D0%B0%20%D0%9D-%D0%BC%D0%BE%D1%81%D1%82%D0%B0.jpg)

Топология печатной платы Altium Designer:
![Топология платы](https://github.com/ArtemMechanik/step-motor-driver-from-tow-MCU-pins/blob/dee9e6c7441507ab14894919f62d11e6d6f887ac/source/%D0%A2%D0%BE%D0%BF%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D1%8F%20%D0%BF%D0%BB%D0%B0%D1%82%D1%8B.jpg)

3D модель печатной платы Altium Designer:
![3D модель печатной платы](https://github.com/ArtemMechanik/step-motor-driver-from-tow-MCU-pins/blob/e6e618f87c6f3b225f60fe9b9aeeb4eeddc96dfe/source/3D%20%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C%20%D0%BF%D0%B5%D1%87%D0%B0%D1%82%D0%BD%D0%BE%D0%B9%20%D0%BF%D0%BB%D0%B0%D1%82%D1%8B.jpg)

Отладочная плата изготовлена по технологии ЛУТ:
![отладочная плата ЛУТ](https://github.com/ArtemMechanik/step-motor-driver-from-tow-MCU-pins/blob/b09a7d34708fb8837f7ed4e5dbdbdd89ef3b1333/source/%D0%9F%D0%B5%D1%87%D0%B0%D1%82%D0%BD%D0%B0%D1%8F%20%D0%BF%D0%BB%D0%B0%D1%82%D0%B0%20%D0%9B%D0%A3%D0%A2.jpg)
